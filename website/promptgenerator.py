import nvdlib
import pandas as pd
import openai

#Replace 'YOUR_API_KEY' with your actual API key
#api_key = '1aac5d44-2d62-415e-92a8-ff2a6e251fc0'

#Fetch details of a specific CVE to serve as an example
#cve_id = 'CVE-2021-26855'
#cve_details = nvdlib.searchCVE(cveId=cve_id, key=api_key)
#cve_details = nvdlib.searchCVE(key=api_key,cveId=cve_id)


#if cve_details:
    #print(cve_details)


'''print(f"Severity: {cve_details.v31severity} - Score: {cve_details.v31score}")
print(f"Description: {cve_details.descriptions[0].value}")
print(f"Vector: {cve_details.v31vector}")'''
## Simple data extraction

# Read output file
'''with open('output', 'r') as f:
    output = f.read()'''

#print(output)
# Read lease.txt
#with open('lease.txt') as f:
 #   lease = f.read()
openai_key = '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'


# Create prompt
q = f'''
You are responsible for outputting a pandas query to select a specific group of CVEs from the dataframe, for example, if I give you the following prompt: "I want CVEs with a score greater than 7", you should return the following query: "df[df['v31score'] > 7]". You should return the query as a string.
Do not infer any data based on previous training, strictly use only source text given below as input.
This are the "parameters" you can make queries with:
data is in ISO 8601 date/time format!!
========
['id', 'description', 'sourceIdentifier', 'published', 'lastModified',
       'vulnStatus', 'exploitAdd', 'actionDue', 'requiredAction', 'references',
       'cwe', 'configurations', 'url', 'cpe', 'v31score', 'v30score',
       'v2score', 'v31vector', 'v30vector', 'v2vector', 'v31severity',
       'v30severity', 'v2severity', 'v31exploitability', 'v30exploitability',
       'v2exploitability', 'v31impactScore', 'v30impactScore', 'v2impactScore',
       'v31attackVector', 'v2accessVector', 'v31attackComplexity',
       'v2accessComplexity', 'v31privilegesRequired', 'v31userInteraction',
       'v31scope', 'v31confidentialityImpact', 'v2authentication',
       'v2confidentialityImpact', 'v31integrityImpact', 'v2integrityImpact',
       'v31availabilityImpact', 'v2availabilityImpact'],
       ========
       NOW THIS IS AN EXAMPLE OF A CVE PARAMETERS and the respective datatype example SO YOU CAN CREATE THE QUERIES ACCORDINGLY TO EXACTLY WHAT I WANT
       {[{'id': 'CVE-2021-26855', 'sourceIdentifier': 'secure@microsoft.com', 'published': '2021-03-03T00:15:12.103', 'lastModified': '2024-02-15T20:18:22.123', 'vulnStatus': 'Analyzed', 'cisaExploitAdd': '2021-11-03', 'cisaActionDue': '2021-04-16', 'cisaRequiredAction': 'Apply updates per vendor instructions.', 'cisaVulnerabilityName': 'Microsoft Exchange Server Remote Code Execution Vulnerability', 'descriptions': [{'lang': 'en', 'value': 'Microsoft Exchange Server Remote Code Execution Vulnerability'}, {'lang': 'es', 'value': 'Una Vulnerabilidad de Ejecución de código remota de Microsoft Exchange Server. Este ID de CVE es diferente de CVE-2021-26412, CVE-2021-26854, CVE-2021-26857, CVE-2021-26858, CVE-2021-27065, CVE-2021-27078'}], 'metrics': {'cvssMetricV31': [{'source': 'secure@microsoft.com', 'type': 'Primary', 'cvssData': {'version': '3.1', 'vectorString': 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N', 'attackVector': 'NETWORK', 'attackComplexity': 'LOW', 'privilegesRequired': 'NONE', 'userInteraction': 'NONE', 'scope': 'UNCHANGED', 'confidentialityImpact': 'HIGH', 'integrityImpact': 'HIGH', 'availabilityImpact': 'NONE', 'baseScore': 9.1, 'baseSeverity': 'CRITICAL'}, 'exploitabilityScore': 3.9, 'impactScore': 5.2}, {'source': 'nvd@nist.gov', 'type': 'Secondary', 'cvssData': {'version': '3.1', 'vectorString': 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H', 'attackVector': 'NETWORK', 'attackComplexity': 'LOW', 'privilegesRequired': 'NONE', 'userInteraction': 'NONE', 'scope': 'UNCHANGED', 'confidentialityImpact': 'HIGH', 'integrityImpact': 'HIGH', 'availabilityImpact': 'HIGH', 'baseScore': 9.8, 'baseSeverity': 'CRITICAL'}, 'exploitabilityScore': 3.9, 'impactScore': 5.9}], 'cvssMetricV2': [{'source': 'nvd@nist.gov', 'type': 'Primary', 'cvssData': {'version': '2.0', 'vectorString': 'AV:N/AC:L/Au:N/C:P/I:P/A:P', 'accessVector': 'NETWORK', 'accessComplexity': 'LOW', 'authentication': 'NONE', 'confidentialityImpact': 'PARTIAL', 'integrityImpact': 'PARTIAL', 'availabilityImpact': 'PARTIAL', 'baseScore': 7.5}, 'baseSeverity': 'HIGH', 'exploitabilityScore': 10.0, 'impactScore': 6.4, 'acInsufInfo': False, 'obtainAllPrivilege': False, 'obtainUserPrivilege': False, 'obtainOtherPrivilege': False, 'userInteractionRequired': False}]}, 'weaknesses': [{'source': 'nvd@nist.gov', 'type': 'Primary', 'description': [{'lang': 'en', 'value': 'CWE-918'}]}], 'configurations': [{'nodes': [{'operator': 'OR', 'negate': False, 'cpeMatch': [{'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_21:*:*:*:*:*:*', 'matchCriteriaId': 'B560F8FD-068E-4A16-A37F-A62DCE88FCF2'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_22:*:*:*:*:*:*', 'matchCriteriaId': '751FD35F-2ECD-4B75-9589-988CC6AD3058'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_23:*:*:*:*:*:*', 'matchCriteriaId': 'DA166F2A-D83B-4D50-AD0B-668D813E0585'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_10:*:*:*:*:*:*', 'matchCriteriaId': '63E362CB-CF75-4B7E-A4B1-D6D84AFCBB68'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_11:*:*:*:*:*:*', 'matchCriteriaId': '9BE04790-85A2-4078-88CE-1787BC5172E7'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_12:*:*:*:*:*:*', 'matchCriteriaId': 'CCF101BE-27FD-4E2D-A694-C606BD3D1ED7'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_13:*:*:*:*:*:*', 'matchCriteriaId': '4DF5BDB5-205D-4B64-A49A-0152AFCF4A13'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_14:*:*:*:*:*:*', 'matchCriteriaId': '55284CF7-0D04-4216-83FE-4B1F9CA94207'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_15:*:*:*:*:*:*', 'matchCriteriaId': 'CA2CE223-AA49-49E6-AC32-59270EFF55AD'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_16:*:*:*:*:*:*', 'matchCriteriaId': '4830D6A9-AF74-480C-8F69-8648CD619980'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_17:*:*:*:*:*:*', 'matchCriteriaId': '079E1E3F-FF25-4B0D-AC98-191D6455A014'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_18:*:*:*:*:*:*', 'matchCriteriaId': '29805EC7-6403-44B9-91EC-109C087E98EB'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_19:*:*:*:*:*:*', 'matchCriteriaId': '28FCA0E8-7D27-4746-9731-91B834CA3E64'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_8:*:*:*:*:*:*', 'matchCriteriaId': '075E907F-AF2F-4C31-86C7-51972BE412A1'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_9:*:*:*:*:*:*', 'matchCriteriaId': '69AF19DC-3D65-49A8-A85F-511085CDF27B'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:-:*:*:*:*:*:*', 'matchCriteriaId': '40D8A6DB-9225-4A3F-AD76-192F6CCCF002'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_1:*:*:*:*:*:*', 'matchCriteriaId': '051DE6C4-7456-4C42-BC51-253208AADB4E'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_2:*:*:*:*:*:*', 'matchCriteriaId': 'EE320413-D2C9-4B28-89BF-361B44A3F0FF'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_3:*:*:*:*:*:*', 'matchCriteriaId': '104F96DC-E280-4E0A-8586-B043B55888C2'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_4:*:*:*:*:*:*', 'matchCriteriaId': '73B3B3FE-7E85-4B86-A983-2C410FFEF4B8'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_5:*:*:*:*:*:*', 'matchCriteriaId': '8A9FB275-7F17-48B2-B528-BE89309D2AF5'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_6:*:*:*:*:*:*', 'matchCriteriaId': 'D4AB3C25-CEA8-4D66-AEE4-953C8B17911A'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_7:*:*:*:*:*:*', 'matchCriteriaId': '36CE5C6D-9A04-41F5-AE7C-265779833649'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_8:*:*:*:*:*:*', 'matchCriteriaId': '44ECF39A-1DE1-4870-A494-06A53494338D'}]}]}], 'references': [{'url': 'http://packetstormsecurity.com/files/161846/Microsoft-Exchange-2019-SSRF-Arbitrary-File-Write.html', 'source': 'secure@microsoft.com', 'tags': ['Exploit', 'Third Party Advisory', 'VDB Entry']}, {'url': 'http://packetstormsecurity.com/files/161938/Microsoft-Exchange-ProxyLogon-Remote-Code-Execution.html', 'source': 'secure@microsoft.com', 'tags': ['Exploit', 'Third Party Advisory', 'VDB Entry']}, {'url': 'http://packetstormsecurity.com/files/162610/Microsoft-Exchange-2019-Unauthenticated-Email-Download.html', 'source': 'secure@microsoft.com', 'tags': ['Exploit', 'Third Party Advisory', 'VDB Entry']}, {'url': 'http://packetstormsecurity.com/files/162736/Microsoft-Exchange-ProxyLogon-Collector.html', 'source': 'secure@microsoft.com', 'tags': ['Exploit', 'Third Party Advisory', 'VDB Entry']}, {'url': 'https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2021-26855', 'source': 'secure@microsoft.com', 'tags': ['Patch', 'Vendor Advisory']}], 'cpe': [{'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_21:*:*:*:*:*:*', 'matchCriteriaId': 'B560F8FD-068E-4A16-A37F-A62DCE88FCF2'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_22:*:*:*:*:*:*', 'matchCriteriaId': '751FD35F-2ECD-4B75-9589-988CC6AD3058'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_23:*:*:*:*:*:*', 'matchCriteriaId': 'DA166F2A-D83B-4D50-AD0B-668D813E0585'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_10:*:*:*:*:*:*', 'matchCriteriaId': '63E362CB-CF75-4B7E-A4B1-D6D84AFCBB68'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_11:*:*:*:*:*:*', 'matchCriteriaId': '9BE04790-85A2-4078-88CE-1787BC5172E7'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_12:*:*:*:*:*:*', 'matchCriteriaId': 'CCF101BE-27FD-4E2D-A694-C606BD3D1ED7'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_13:*:*:*:*:*:*', 'matchCriteriaId': '4DF5BDB5-205D-4B64-A49A-0152AFCF4A13'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_14:*:*:*:*:*:*', 'matchCriteriaId': '55284CF7-0D04-4216-83FE-4B1F9CA94207'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_15:*:*:*:*:*:*', 'matchCriteriaId': 'CA2CE223-AA49-49E6-AC32-59270EFF55AD'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_16:*:*:*:*:*:*', 'matchCriteriaId': '4830D6A9-AF74-480C-8F69-8648CD619980'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_17:*:*:*:*:*:*', 'matchCriteriaId': '079E1E3F-FF25-4B0D-AC98-191D6455A014'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_18:*:*:*:*:*:*', 'matchCriteriaId': '29805EC7-6403-44B9-91EC-109C087E98EB'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_19:*:*:*:*:*:*', 'matchCriteriaId': '28FCA0E8-7D27-4746-9731-91B834CA3E64'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_8:*:*:*:*:*:*', 'matchCriteriaId': '075E907F-AF2F-4C31-86C7-51972BE412A1'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_9:*:*:*:*:*:*', 'matchCriteriaId': '69AF19DC-3D65-49A8-A85F-511085CDF27B'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:-:*:*:*:*:*:*', 'matchCriteriaId': '40D8A6DB-9225-4A3F-AD76-192F6CCCF002'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_1:*:*:*:*:*:*', 'matchCriteriaId': '051DE6C4-7456-4C42-BC51-253208AADB4E'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_2:*:*:*:*:*:*', 'matchCriteriaId': 'EE320413-D2C9-4B28-89BF-361B44A3F0FF'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_3:*:*:*:*:*:*', 'matchCriteriaId': '104F96DC-E280-4E0A-8586-B043B55888C2'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_4:*:*:*:*:*:*', 'matchCriteriaId': '73B3B3FE-7E85-4B86-A983-2C410FFEF4B8'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_5:*:*:*:*:*:*', 'matchCriteriaId': '8A9FB275-7F17-48B2-B528-BE89309D2AF5'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_6:*:*:*:*:*:*', 'matchCriteriaId': 'D4AB3C25-CEA8-4D66-AEE4-953C8B17911A'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_7:*:*:*:*:*:*', 'matchCriteriaId': '36CE5C6D-9A04-41F5-AE7C-265779833649'}, {'vulnerable': True, 'criteria': 'cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_8:*:*:*:*:*:*', 'matchCriteriaId': '44ECF39A-1DE1-4870-A494-06A53494338D'}], 'cwe': [{'lang': 'en', 'value': 'CWE-918'}], 'url': 'https://nvd.nist.gov/vuln/detail/CVE-2021-26855', 'v31score': 9.1, 'v31vector': 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N', 'v31severity': 'CRITICAL', 'v31attackVector': 'NETWORK', 'v31attackComplexity': 'LOW', 'v31privilegesRequired': 'NONE', 'v31userInteraction': 'NONE', 'v31scope': 'UNCHANGED', 'v31confidentialityImpact': 'HIGH', 'v31integrityImpact': 'HIGH', 'v31availabilityImpact': 'NONE', 'v31exploitability': 3.9, 'v31impactScore': 5.2, 'v2score': 7.5, 'v2vector': 'AV:N/AC:L/Au:N/C:P/I:P/A:P', 'v2severity': 'HIGH', 'v2accessVector': 'NETWORK', 'v2accessComplexity': 'LOW', 'v2authentication': 'NONE', 'v2confidentialityImpact': 'PARTIAL', 'v2integrityImpact': 'PARTIAL', 'v2availabilityImpact': 'PARTIAL', 'v2exploitability': 10.0, 'v2impactScore': 6.4, 'score': ['V31', 9.1, 'CRITICAL']}]}
        ======
'''

messages = [{"role": "system",
             "content": q}]


def model(prompt):
    openai.api_key = "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"
    client = openai.OpenAI(api_key="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")
    while True:
        messages.append({"role": "user", "content": prompt})
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            temperature=1,
            max_tokens=150
        )
        
        answer = response.choices[0].message.content
        messages.append({"role": "assistant", "content": answer})
        return answer
    